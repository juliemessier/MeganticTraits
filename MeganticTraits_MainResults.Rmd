---
title: "MeganticTraits_Species~Traits" 
author: "Julie Messier" 
output: 
   pdf_document:
      toc: true
      toc_depth: 3
      fig_width: 5
      fig_height: 4
date: '`r Sys.Date()`'
---



```{r,include=FALSE}
#<<LIBRARIES>>
library(car) # for powerTransform
library(vegan) # for decostand (standardizing data)
library(tree) # for tree()
library(MASS) # for glm.nb()  
library(mgcv) # for gam()
library(MuMIn)

wrk.dir<-("C:/Users/Julie/Desktop/Postdoc/PROJECT - Megantic Traits/Workspaces/") # Workspaces
data.dir<-(("C:/Users/Julie/Desktop/Postdoc/PROJECT - Megantic Trait/Data/")) # data
res.dir<-("C:/Users/Julie/Desktop/Postdoc/PROJECT - Megantic Traits/Results/")  # Results
grp.dir<-("C:/Users/Julie/Desktop/Postdoc/PROJECT - Megantic Trait/Graphs/")   # Graphs
fct.dir<-("C:/Users/Julie/Desktop/Postdoc/PROJECT - Megantic Trait/Functions/") # Functions

```    

```{r,echo=F,eval=T, include=FALSE}
#<<LOAD FILES>>

#U.traits4.sp
load(file=paste0(wrk.dir,'Species-Level.Traits.Understory-Layer.with.MycFrac.and.SeedSize.and.PCs.RData')) 
dim(U.traits4.sp)

# U.Ys.c
load(file=paste0(wrk.dir,'All.Response.variables.Understory.Layer.Inf.removed.RData')) 
dim(U.Ys.c)

# subset abundance data to include only the species with trait data 
    sp.response<-U.Ys.c[rownames(U.Ys.c)%in%rownames(U.traits4.sp),]
    dim(sp.response)
    
# subset trait data to include only the species with abundance data
Xs<-U.traits4.sp[rownames(U.traits4.sp)%in%rownames(U.Ys.c),]
dim(Xs)

# Create long and short lists of traits 
    Trait.Names.8t<-c("Log.Ht.veg","Max.Root.Loca","Log.Lamina.thck","LDMC","Log.Leaf.Area",  
                        "Leaf.Mass.Frac","SRL","Myc.Frac")
    length(which(complete.cases(Xs[,Trait.Names.8t])))
      # 36 species
    
    Trait.Names.5t<-c("Log.Ht.veg","Log.Lamina.thck","LDMC","Log.Leaf.Area","Leaf.Mass.Frac")
    length(which(complete.cases(Xs[,Trait.Names.5t])))
      # 46 species
    
Xs<-U.traits4.sp[rownames(U.traits4.sp)%in%rownames(U.Ys.c),]

    dat.8t<-merge(sp.response[,c("LatinName","abundance.ratio","occurence.ratio",'ElevDif')],
                    Xs[which(complete.cases(Xs[,Trait.Names.8t])),Trait.Names.8t],
                    by="row.names",all.y=T)
    # Cleanup
    dim(dat.8t)
    # 36 13
    rownames(dat.8t)<-dat.8t$Row.names
    dat.8t$Row.names<-NULL
    dim(dat.8t)
    # 36 12
```

#(A) Abundance vs 8 Traits

## A1 - Explore Trait Interactions
   
### A1.1 - Regression Tree
   
```{r,echo=F,eval=T}
   
    par(mfrow=c(1,1))
    tree.model.abund<-tree(sp.response$abundance.ratio~.,data=Xs[,Trait.Names.8t],
                     control=tree.control(nobs=36,mincut=3))
    plot(tree.model.abund); text(tree.model.abund);title('Regression Tree \n Abundance.ratio vs 8 traits')
      # Myc.frac is most important variable       # for sp. with high myc.frac, SRL matters
 
    tree.model.abund
```    
Deviance explained:
```{r,echo=T}
  1-(deviance(tree.model.abund)/178.1) 
```
            =======
            A1 - SUMMARY
            trait-trait interactions to include in global model: 
            
                * Myc.Frac:SRL 
                * SRL:Max.Root.Loca
                * SRL:Log.Ht.veg
                * Myc.Frac:SRL:Max.Root.Loca
                * Myc.Frac:SRL:Log.Ht.veg
                
            =======


## A2 - Run Full Model
```{r,echo=F}
H.full.abund<-glm(abundance.ratio~
                    Myc.Frac+SRL+Max.Root.Loca+Log.Ht.veg+
                     Log.Lamina.thck+LDMC+Log.Leaf.Area+Leaf.Mass.Frac,
                 data=dat.8t,
                 family=Gamma(link='log'),
                 maxit=1000)
summary(H.full.abund)$coefficients
```
Deviance explained:
```{r,echo=T}
1-(H.full.abund$deviance/H.full.abund$null) 
```
=======
SUMMARY
Only Mycorrhizal fraction is significant. 
Full model explains 36% of deviance
=======

## A3 - Find best subset of models with AICc dredge ####

```{r,echo=F}

   # Not including both Myc.Frac and log(Myc.Frac).
   #        - all 1st order terms 
   #        - 2-way and 3-way trait interactions from regression tree
   #        - Don't include trait interaction from interaction screening.
         
          # rewrite H1 with na.action='fail' - required by dredge ()
          #
          
H.global.abund<-glm(abundance.ratio~
                        Myc.Frac+SRL+Max.Root.Loca+Log.Ht.veg+Log.Lamina.thck+LDMC+Log.Leaf.Area+Leaf.Mass.Frac+
                        Myc.Frac:SRL + SRL:Max.Root.Loca + SRL:Log.Ht.veg+
                        Myc.Frac:SRL:Log.Ht.veg + Myc.Frac:SRL:Max.Root.Loca,
                     data=dat.8t,
                     family=Gamma(link='log'),
                     maxit=1000,na.action='na.fail')
```
```{r,echo=T,eval=T,message=F}
dredge.abund<-dredge(H.global.abund,beta='sd',rank="AICc",m.lim = c(0,6),extra=c("R^2"),trace=F)
dredge.abund[1:5]

```


